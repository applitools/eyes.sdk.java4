language: java
jdk: oraclejdk8
dist: trusty

before_script:
  - export APPLITOOLS_BATCH_ID=`uuidgen -t`
  - echo $APPLITOOLS_BATCH_ID
  - echo $RELEASE_CANDIDATE
  # Grab SDK name and version from git tag
  - export SDK_NAME="java4"
  - SDK_VERSION=$(cut -d'v' -f2 <<<"$TRAVIS_TAG")
  - export APPLITOOLS_REPORT_ID=$(git log --pretty=format:'%h' -n 1)
  - export TEST_REPORT_SANDBOX=false
  # Runs only during the release process. Set 'TestReportSandbox' key to false. It means that test reports will go to release sheet. Stops if CHANGELOG.md has the wrong format.
  - if [[ "$SDK_NAME" && "$SDK_VERSION" ]]; then
    export TEST_REPORT_SANDBOX = false;
    TMP_CHANGELOG=$(sh extract_change_log.sh "$SDK_VERSION" "CHANGELOG.md");
    CHANGELOG=$([ -z "$TMP_CHANGELOG" ] && echo "THERE IS NO CHANGELOG FOR VERSION $SDK_VERSION"; echo "$TMP_CHANGELOG");
    if [[ (-z "$TMP_CHANGELOG") ]]; then
    echo "THE CHANGELOG IS NOT CORRECT";
    exit 1;
    fi
    fi
  # Upload apps to BrowserStack
  - sh upload_app.sh "https://applitools.bintray.com/Examples/android/1.2/app_android.apk" "app_android"
  - sh upload_app.sh "https://applitools.bintray.com/Examples/androidx/1.0.0/app_androidx.apk" "app_androidx"
  - sh upload_app.sh "https://applitools.bintray.com/Examples/ipa/IOSTestApp.ipa" "app_ios"

stages:
  - tests
  - deploy
  - release-event

jobs:
  include:
    - stage: test
      script:
        - cd eyes.appium.java
        - echo "Test started"
        - mvn test
        - cd ..

    - stage: deploy
      script:
        - echo "Deploy"
        #-git remote set-url origin https://${GITHUB_TOKEN}@github.com/${TRAVIS_REPO_SLUG};
        #-mvn versions:set -DnewVersion=$SDK_VERSION;
        #-mvn versions:commit;
        #-git add */pom.xml pom.xml;
        #-git commit -m 'update pom version';
        #-git push origin HEAD:$RELEASE_BRANCH;

    - stage: release-event
      script:
        - echo $TMP_CHANGELOG
        - COMMITTER_EMAIL="$(git log -1 $TRAVIS_COMMIT --pretty="%cE")"
        - TEST_COVERAGE_GAP=$(cat eyes.appium.java/testCoverageGap.txt)
        - sh send_mail.sh "$SDK_NAME" "$SDK_VERSION" "$CHANGELOG" "$TEST_COVERAGE_GAP" "$COMMITTER_EMAIL";